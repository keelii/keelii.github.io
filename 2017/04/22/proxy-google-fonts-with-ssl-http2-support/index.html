<!DOCTYPE html>   
<html class="no-js" lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>Nginx 配置 Google Fonts 反向代理开启 HTTP2/SSL 支持</title>
    <meta name="description" content="__ you don&#39;t know yet">
    <meta name="keywords" content="">
    <meta name="author" content="keelii">
    <meta name="generator" content="Hugo 0.29" />

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://keelii.github.io/2017/04/22/proxy-google-fonts-with-ssl-http2-support/">
    <link href="https://keelii.github.io/favicon.ico" rel="icon">
    <link href="https://keelii.github.io/atom.xml" rel="alternate" type="application/rss+xml" title="Something">

    
    <link href="//fonts.crazy4code.com/css?family=PT&#43;Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="//fonts.crazy4code.com/css?family=PT&#43;Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="/stylesheets/screen.css" rel="stylesheet" type="text/css">
    <link href="//cdn.bootcss.com/highlight.js/9.7.0/styles/solarized-dark.min.css" rel="stylesheet" type="text/css">

    <meta name="360-site-verification" content="97274d5ff16511caf615a565d3257ce8">
    
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-79264835-1', 'auto');
    ga('send', 'pageview');
    </script>

</head>
<body>

<header role="banner">
    <hgroup>
        <h1><a href="https://keelii.github.io/">Something</a></h1>
        <h2>__ you don&#39;t know yet</h2>
    </hgroup>
</header>


<nav role="navigation">
    <ul class="subscription" data-subscription="rss">
        <li>
            
        </li>
    </ul>

    <form action="https://www.google.com/search" method="get">
        <fieldset role="search">
            <input type="hidden" name="sitesearch" value="https://keelii.github.io/">
            <input class="search" type="text" name="q" results="0" placeholder="Search" />
        </fieldset>
    </form>

    <ul class="main-navigation">
        
        <li><a href="https://keelii.github.io/">Blog</a> </li>
        
        <li><a href="https://keelii.github.io/archives">Archives</a> </li>
        
        <li><a href="https://keelii.github.io/about">About</a> </li>
        
    </ul>
</nav>


<div id="main">
    <div id="content">
        <div>
            <article class="hentry" role="article">
                <header>
                    <h1 class="entry-title">Nginx 配置 Google Fonts 反向代理开启 HTTP2/SSL 支持</h1>
                    <p class="meta">
                        <time class="entry-date" datetime="2017-04-22 11:19:58">
                            <span class="date">2017-4-22</span>
                            <span class="time">11:19 AM</span>
                        </time>
                    </p>
                </header>

                <div class="entry-content">

<p>由于博客主题使用了 Google fonts PT Serif 字体，国内只能通过中科大的代理来使用 Google fonts 字体。然而最近发现其速度不稳定，响应时间有时候甚至超过 600ms。刚好因为自己有 <a href="http://www.vultr.com/?ref=6805146">vultr 的 VPS(带小尾巴)</a> 就自己动手搭了个来用</p>

<p>VPS 环境如下：</p>

<ul>
<li>Ubuntu 14.04</li>
<li>Nginx 1.12.0 (最新版各别配置与之前不一样)</li>
<li>Openssl 1.0.2j (新版 Nginx 开启 http2 需要的最低 openssl 版本)</li>
</ul>

<h2 id="重新编译安装-nginx">重新编译安装 Nginx</h2>

<p>如果之前编译安装没开启相关模块的话需要重新编译，大概参数如下：</p>

<pre><code class="language-bash">./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-openssl=/usr/local/ssl --with-http_v2_module --with-http_sub_module
</code></pre>

<p>编译完没有出错的话就 <code>make &amp;&amp; make install</code> 就 OK 了</p>

<h2 id="配置-nginx-反代">配置 Nginx 反代</h2>

<h3 id="基本配置">基本配置</h3>

<pre><code class="language-nginx">upstream google {
    server fonts.googleapis.com:80;
}

upstream gstatic {
    server fonts.gstatic.com:80;
}
proxy_temp_path   /your/path/tmp 1 2;
proxy_cache_path  /your/path/cache levels=1:2 keys_zone=cache1:100m inactive=30d max_size=1g;
</code></pre>

<h3 id="80-端口配置">80 端口配置</h3>

<pre><code class="language-nginx">server {
    listen 80;
    server_name your.proxy.domain;
    root /your/path/;
    location /css {
        sub_filter 'fonts.gstatic.com' 'your.proxy.domain';
        sub_filter_once off;
        sub_filter_types text/css;
        proxy_pass_header Server;
        proxy_set_header Host fonts.googleapis.com;
        proxy_set_header Accept-Encoding '';
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://google;
        proxy_cache cache1;
        proxy_cache_key $host$uri$is_args$args;
        proxy_cache_valid 200 304 10m;
        expires 365d;
    }
    location / {
        proxy_pass_header Server;
        proxy_set_header Host fonts.gstatic.com;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://gstatic;
        proxy_cache cache1;
        proxy_cache_key $host$uri$is_args$args;
        proxy_cache_valid 200 304 10m;
        expires 365d;
    }
}
</code></pre>

<h3 id="443-端口配置">443 端口配置</h3>

<p>首先你得有个免费的 HTTPS 证书，这个可以参考我之前的文章：<a href="/2016/06/12/free-https-cert-lets-encrypt-apply-install/">免费 Https 证书（Let&rsquo;S Encrypt）申请与配置</a></p>

<p>注意设置 <code>sub_filter</code> 字段的时候 <strong>你的域名要加上 https://</strong>，要不然会出现代理的 CSS 文件中的字体文件引用是 HTTP 而请求报 <code>blocked/mixed-content</code> 错</p>

<pre><code class="language-nginx">server {
    listen 443 ssl http2;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/your.proxy.domain/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your.proxy.domain/privkey.pem;
    ssl_dhparam /etc/ssl/certs/dhparams.pem;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!MD5;

    server_name  your.proxy.domain;
    root /var/sites/fonts/;

    location /css {
        sub_filter 'http://fonts.gstatic.com' 'https://your.proxy.domain';
        sub_filter_once off;
        sub_filter_types text/css;
        proxy_pass_header Server;
        proxy_set_header Host fonts.googleapis.com;
        proxy_set_header Accept-Encoding '';
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://google;
        proxy_cache cache1;
        proxy_cache_key $host$uri$is_args$args;
        proxy_cache_valid 200 304 10m;
        expires 365d;
    }

    location / {
        proxy_pass_header Server;
        proxy_set_header Host fonts.gstatic.com;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://gstatic;
        proxy_cache cache1;
        proxy_cache_key $host$uri$is_args$args;
        proxy_cache_valid 200 304 10m;
        expires 365d;
    }
}
</code></pre>

<h3 id="安全防盗链">安全防盗链</h3>

<p>如果不共享给其它人用的话还需要在配置中加入 referer 白名单判断，不符合条件的将返回 403</p>

<pre><code class="language-nginx">valid_referers server_name *.your.domain.com *.other.domain.com;
if ($invalid_referer) {
    return 403;
}
</code></pre>
</div>
                <footer>
                    <p class="meta">
                        <span class="byline author vcard">Posted</span>
                        
                        <span class="span">on</span>
                        <span class="categories">
                            
                            
                            <a class="category 0|2" href="https://keelii.github.io/categories/Server">Server</a>,
                            
                            <a class="category 1|2" href="https://keelii.github.io/categories/Linux">Linux</a>
                            
                        </span>
                        
                    </p>
                    <p class="meta">
                        <span class="span">Last modified •</span>
                        <time class="entry-date" datetime="2017-05-02 15:19:43">
                            <span class="date">2017-5-2</span>
                            <span class="time">15:19 PM</span>
                        </time>
                    </p>
                    <p class="meta">
                        
                        <span class="basic-alignment left">
                            &laquo; <a href="https://keelii.github.io/2017/02/19/basic-operations-of-relation-algebra/" title="Previous Post: 关系代数的基本运算">关系代数的基本运算</a>
                        </span>
                        

                        
                        <span class="basic-alignment right">
                            <a href="https://keelii.github.io/2017/04/29/sublime-text-3-configure-eslint/" title="Nextious Post: Sublime text 3 配置 ESLint 代码检查">Sublime text 3 配置 ESLint 代码检查</a> &raquo;
                        </span>
                        
                    </p>
                </footer>
            </article>
            <section>
    <h1>Comments</h1>
    <div id="disqus_thread"></div>
    <script>
    (function() {
    var d = document, s = d.createElement('script');
    s.src = '//keelii-blog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


        </div>

        <aside class="sidebar">
    
        
<section id="side-toc" class="side-toc odd" style="width: 100%;">
    <h1>Table  of contents</h1>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#重新编译安装-nginx">重新编译安装 Nginx</a></li>
<li><a href="#配置-nginx-反代">配置 Nginx 反代</a>
<ul>
<li><a href="#基本配置">基本配置</a></li>
<li><a href="#80-端口配置">80 端口配置</a></li>
<li><a href="#443-端口配置">443 端口配置</a></li>
<li><a href="#安全防盗链">安全防盗链</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</section>



    
</aside>

    </div>
</div>

<footer role="contentinfo">
    <p>
        Copyright &copy; 2017 - keelii -
        <span class="credit">Powered by <a href="http://gohugo.io/">Hugo</a></span>,
        <span class="credit">Theme Copied from <a href="http://octopress.org/">Octopress</a></span>
    </p>
</footer>


<script src="//cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
<script src="/javascripts/octopress.js"></script>



<script src="/javascripts/highlight.pack.js"></script>
<script src="/javascripts/post.js"></script>
<script>
if (typeof hljs !=="undefined") hljs.initHighlightingOnLoad()
</script>





<!--
# There are some hotkeys for better experience #

[s] for search input
[t] for scroll to top
[h] for prev article
[l] for next article
[j] for scroll page up 300px
[k] for scroll page down 300px
[G] for scroll page bottom
-->

</body>
</html>
